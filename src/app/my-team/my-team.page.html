<ion-content class="ion-padding page-containerOn">
   <div class="row-space-between">
      <div>
         <h1 class="header-title">My Team</h1>
         <p>View and manage your direct and extended team</p>
      </div>

      <ion-buttons slot="end" class="header-buttons">
         <!-- <ion-button (click)="refreshAttendanceStatus()" *ngIf="teamMembers.length && !showAttendance"
            class="primary-outline-btn">
            <ion-icon id="teamIcon" name="refresh-circle-outline"></ion-icon>
            Refresh
         </ion-button> -->
         <ion-button (click)="navigateToTimesheetApprovals()" *ngIf="teamMembers.length && isManager"
            class="primary-outline-btn" id="timeApp">
            <ion-icon name="time-outline"></ion-icon> Timesheet Approval
         </ion-button>
         <ion-button (click)="navigateToLeaveApprovals()" *ngIf="teamMembers.length && isManager"
            class="primary-outline-btn" id="leaveApp">
            <ion-img src="../../assets/home-icons/noun-flight-1442230 1.svg"></ion-img>
            Leaves Approval
         </ion-button>
         <ion-button (click)="navigateToWfhApprovals()" *ngIf="teamMembers.length && isManager"
            class="primary-outline-btn" id='AttApp'>
            <ion-img src="../../assets/home-icons/attend-icon.svg"></ion-img>
            Attendance Approval
         </ion-button>
         <ion-button (click)="toggleAttendanceView()" *ngIf="teamMembers.length" class="primary-outline-btn">
            <ion-icon [name]="showAttendance ? 'people-outline' : 'calendar-outline'"></ion-icon>
            Team Details
         </ion-button>
      </ion-buttons>
   </div>

   <!-- â³ Loader -->
   <div class="loading-container" *ngIf="loading">
      <ion-spinner></ion-spinner>
      <p>Loading team members...</p>
   </div>

   <!-- ðŸ“… Attendance View -->
   <div *ngIf="!loading && showAttendance && (teamMembers.length || attendanceSummary)">
      <div class="date-card">
         <!-- Date Picker -->
         <h2>Attendance Reports</h2>
         <div class="row-left">
            <ion-label>Select Date</ion-label>
            <ion-datetime-button datetime="attendance-date"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
               <ng-template>
                  <ion-datetime id="attendance-date" presentation="date" [value]="selectedDate"
                     (ionChange)="onDateChange($event)"></ion-datetime>
               </ng-template>
            </ion-modal>
         </div>
      </div>



      <!-- Filter Chips -->
      <!-- <div class="filter-chips">
         <ion-chip [color]="attendanceFilter === 'all' ? 'primary' : 'light'" (click)="setAttendanceFilter('all')">
            <ion-icon name="people-outline"></ion-icon>
            <ion-label>All ({{ attendanceSummary?.total_team || 0 }})</ion-label>
         </ion-chip>

         <ion-chip [color]="attendanceFilter === 'present' ? 'success' : 'light'"
            (click)="setAttendanceFilter('present')">
            <ion-icon name="checkmark-circle"></ion-icon>
            <ion-label>Present ({{ attendanceSummary?.present || 0 }})</ion-label>
         </ion-chip>

         <ion-chip [color]="attendanceFilter === 'absent' ? 'danger' : 'light'" (click)="setAttendanceFilter('absent')">
            <ion-icon name="close-circle"></ion-icon>
            <ion-label>Absent ({{ attendanceSummary?.absent || 0 }})</ion-label>
         </ion-chip>

         <ion-chip [color]="attendanceFilter === 'on_leave' ? 'warning' : 'light'"
            (click)="setAttendanceFilter('on_leave')">
            <ion-icon name="calendar-outline"></ion-icon>
            <ion-label>On Leave ({{ attendanceSummary?.on_leave || 0 }})</ion-label>
         </ion-chip>
      </div> -->


      <!-- Summary Cards -->
      <div class="summary-cards" *ngIf="attendanceSummary">
         <ion-card class="summary-card">
            <ion-card-content (click)="setAttendanceFilter('all')">
               <div class="summary-item">
                  <ion-img src="../../assets/all-team-bg-blue.svg"></ion-img>
                  <div class="summary-text">
                     <p class="summary-label">Total Team</p>
                     <h2 class="summary-value">{{ attendanceSummary.total_team }}</h2>
                  </div>
               </div>
               <ion-img src="../../assets/total_team.svg" height="50"></ion-img>
            </ion-card-content>
         </ion-card>

         <ion-card class="summary-card">
            <ion-card-content (click)="setAttendanceFilter('present')">
               <div class="summary-item">
                  <ion-img src="../../assets/present-bg-blue.svg"></ion-img>
                  <div class="summary-text">
                     <p class="summary-label">Present</p>
                     <h2 class="summary-value">{{ attendanceSummary.present }}</h2>
                  </div>
               </div>
               <ion-img src="../../assets/presents.svg" height="50"></ion-img>
            </ion-card-content>
         </ion-card>

         <ion-card class="summary-card">
            <ion-card-content (click)="setAttendanceFilter('absent')">
               <div class="summary-item">
                  <ion-img src="../../assets/absent-bg-blue.svg"></ion-img>
                  <div class="summary-text">
                     <p class="summary-label">Absent</p>
                     <h2 class="summary-value">{{ attendanceSummary.absent }}</h2>
                  </div>
               </div>
               <ion-img src="../../assets/absent.svg" height="50"></ion-img>
            </ion-card-content>
         </ion-card>

         <ion-card class="summary-card">
            <ion-card-content (click)="setAttendanceFilter('on_leave')">
               <div class="summary-item">
                  <ion-img src="../../assets/Leave-bg-blue.svg"></ion-img>
                  <div class="summary-text">
                     <p class="summary-label">On Leave</p>
                     <h2 class="summary-value">{{ attendanceSummary.on_leave }}</h2>
                  </div>
               </div>
               <ion-img src="../../assets/Leave.svg" height="50"></ion-img>
            </ion-card-content>
         </ion-card>
      </div>

      <!-- On Leave Card: Only show when 'on_leave' filter is selected -->
      <ion-card *ngIf="attendanceFilter === 'on_leave' && onLeaveToday.length > 0" (click)="onOnLeaveCardClick()"
         style="cursor:pointer;">
         <ion-card-content *ngIf="showOnLeaveList">
            <ion-list>
               <ion-item *ngFor="let leave of onLeaveToday">
                  <ion-avatar slot="start">
                     <img [src]="getProfileImage(leave)" />
                  </ion-avatar>
                  <ion-label>
                     <h3>{{ leave.FirstName }} {{ leave.LastName }}</h3>
                     <p>{{ leave.WorkEmail }}</p>
                     <p><strong>Type:</strong> {{ leave.type_name || leave.leave_type || 'Leave' }}</p>
                     <p><strong>Duration:</strong> {{ leave.start_date }} to {{ leave.end_date }}</p>
                  </ion-label>
               </ion-item>
            </ion-list>
         </ion-card-content>
      </ion-card>

      <!-- Team Attendance List -->
      <div class="team-grid">
         <ion-card class="team-card" *ngFor="let member of filteredMembers">
            <ion-card-content>
               <!-- Avatar Section -->
               <div class=" row-space-between">
                  <div class="row-left">
                     <div class="avatar-section">
                        <ion-img [src]="getProfileImage(member)" class="avatar"></ion-img>
                     </div>
                     <div>
                        <h3 class="member-name">{{ member.FullName || member.full_name ||
                           member.attendance?.employee_name || 'N/A' }}</h3>
                        <p class="member-role">{{ member.designation || member.designation_name ||
                           member.attendance?.designation || 'â€”' }} .
                           {{ member.department || member.department_name || member.attendance?.department || 'â€”' }}
                        </p>
                     </div>
                  </div>
                  <div class="attendance-details" *ngIf="member.attendance">
                     <div class="attendance-info" *ngIf="member.attendance.status === 'absent'">
                        <ion-chip class="absent">
                           <ion-label>Absent</ion-label>
                        </ion-chip>
                     </div>
                     <div class="attendance-info" *ngIf="member.attendance.status === 'present'">
                        <ion-chip class="present">
                           <ion-label>Present</ion-label>
                        </ion-chip>
                        <div [ngClass]="['ribbon', member.attendance.attendance?.work_mode]"
                           *ngIf="member.attendance.attendance?.work_mode">
                           <p>{{ member.attendance.attendance?.work_mode }}</p>
                        </div>
                     </div>

                     <div class="attendance-info" *ngIf="member.attendance.status === 'on_leave'">
                        <ion-chip color="warning" class="info-chip">
                           <ion-icon name="information-circle-outline"></ion-icon>
                           <ion-label>{{ member.attendance.attendance?.leave_type || 'On Leave' }}</ion-label>
                        </ion-chip>
                     </div>
                  </div>
               </div>
               <!-- Member Info -->
               <div class="contact-details">
               <p class="detail-text"><label>Location: </label>{{ member.location_name || member.location_name || 'â€”' }}
               </p>
               <p class="detail-text"><label>Mail: </label>{{ member.WorkEmail || member.work_email || 'â€”' }}</p>
               </div>
            </ion-card-content>
         </ion-card>
      </div>







      <!-- <ion-list class="attendance-list">
         <ion-item *ngFor="let member of filteredMembers" lines="full" class="attendance-item">
            <ion-avatar slot="start">
               <img [src]="getProfileImage(member)" />
            </ion-avatar>

            <ion-label>
               <h2>{{ member.FullName || member.full_name || member.attendance?.employee_name || 'N/A' }}</h2>
               <p>{{ member.WorkEmail || member.work_email || member.attendance?.email || 'â€”' }}</p>
               <p class="sub-text">
                  <ion-icon name="briefcase-outline"></ion-icon>
                  {{ member.designation || member.designation_name || member.attendance?.designation || 'â€”' }}
               </p>
               <p class="sub-text">
                  <ion-icon name="business-outline"></ion-icon>
                  
               </p> -->

      <!-- Attendance Details -->

      <!-- </ion-label>

            <ion-badge slot="end" [color]="getAttendanceBadgeColor(getAttendanceStatus(member))" class="status-badge">
               <ion-icon [name]="getAttendanceIcon(getAttendanceStatus(member))"></ion-icon>
               {{ getAttendanceStatus(member) | titlecase }}
            </ion-badge>
         </ion-item>
      </ion-list> -->
   </div>

   <!-- ðŸ§‘â€ðŸ¤â€ðŸ§‘ Regular Team List -->

   <div class="team-grid" *ngIf="!loading && !showAttendance && teamMembers.length">

      <ion-card class="team-card" *ngFor="let member of teamMembers">
         <ion-card-content>
            <!-- Avatar Section -->
            <div class="row-left">

               <div class="avatar-section">
                  <ion-img [src]="getProfileImage(member)" class="avatar"></ion-img>

                  <div *ngIf="member.id" class="status-badge"
                     [class.badge-in]="getEmployeePunchStatus(member.id).status === 'in'"
                     [class.badge-out]="getEmployeePunchStatus(member.id).status === 'out'">
                     <!-- <ion-icon
                           [name]="getEmployeePunchStatus(member.id).status === 'in' ? 'checkmark' : 'close'"></ion-icon> -->
                  </div>
               </div>
               <div>
                  <h3 class="member-name">{{ member.FullName || member.full_name || 'N/A' }}</h3>
                  <p class="member-role">{{ member.designation || member.designation_name || 'â€”' }} . {{
                     member.department || member.department_name || 'â€”' }}</p>

               </div>
            </div>
            <!-- Member Info -->
            <div class="contact-details">
               <p class="detail-text"><label>Location: </label>{{ member.location_name || member.location_name || 'â€”' }}
               </p>
               <p class="detail-text"><label>Mail: </label>{{ member.WorkEmail || member.work_email || 'â€”' }}</p>
            </div>
         </ion-card-content>
      </ion-card>

   </div>

   <!-- No empty state: always show team grid, even if empty -->

</ion-content>